@startuml Sequence_Add_To_Ticket

skinparam backgroundColor #FEFEFE
skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true
skinparam shadowing false
skinparam defaultFontName Arial

title Ticket Add Product - Sequence Diagram\n<size:12>Flow of adding a product to a ticket with quantity and discount calculation</size>

actor User
participant "app:App" as App
participant "productController:\nProductController" as PC
participant "ticketController:\nTicketController" as TC
participant "ticket:Ticket" as Ticket
participant "product:Product" as Product
participant "<<enumeration>>\nCategories" as Cat

autonumber "<b>[0]"

User -> App ++: ticket add <prodId> <quantity>
activate User

App -> App: parse command
note right
  Command format:
  "ticket add 101 3"
end note

App -> PC ++: productoID(prodId)
PC -> PC: existeId(prodId)

alt Product exists
    PC --> App --: return Product

    App -> TC ++: add(product, quantity)

    alt counter < 100 (capacity check)

        loop for i = 0 to quantity
            TC -> Ticket ++: getProducts()
            return products: ArrayList<Product>

            TC -> Ticket: products.add(product)
            note right
              Product reference added
              (not cloned)
            end note

            TC -> TC: counter++
        end loop

        TC -> TC ++: print()

        TC -> TC: initialize counters\n(stationary, clothes, book, electronic)

        loop for each product in ticket
            TC -> Ticket ++: getProducts()
            return products

            TC -> Product ++: getCategories()
            return category

            TC -> TC: count category occurrences
        end loop

        loop for each product (reverse order)
            TC -> Ticket ++: getProducts().get(i)
            return product

            TC -> Product ++: getPrice()
            return price
            TC -> TC: precioTotal += price

            TC -> Product ++: getCategories()
            return category

            TC -> TC ++: hasDiscount(counters, category)

            alt category count >= 2
                TC --> TC --: true

                TC -> Cat ++: getDiscount(category)
                return discount percentage

                TC -> TC: descuentoTotal += discount * price
                TC -> TC: print product with discount
            else category count < 2
                TC --> TC --: false
                TC -> TC: print product without discount
            end

        end loop

        TC -> TC: precioFinal = precioTotal - descuentoTotal
        TC -> TC: print totals
        TC --> TC --: // print() complete

        TC --> App --: void

        App -> User: "ticket add: ok\n"

    else counter >= 100 (ticket full)
        TC -> User: "Ticket lleno."
        TC --> App --: void
    end

else Product doesn't exist
    PC --> App --: return null
    App -> User: "ID no existe"
end

deactivate User
deactivate App

note over App, TC
  <b>Business Rules Applied:</b>
  1. Maximum 100 products per ticket
  2. Discount applied when â‰¥2 products of same category
  3. Products added by reference (not copied)
  4. Receipt printed after each addition
end note

@enduml

