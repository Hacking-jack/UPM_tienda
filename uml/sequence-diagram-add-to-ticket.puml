@startuml Sequence_Add_To_Ticket

skinparam backgroundColor #FEFEFE
skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true
skinparam shadowing false
skinparam defaultFontName Arial

title Ticket Add Product - Sequence Diagram (Command Pattern)\n<size:12>Flow of adding a product to a ticket using the Command pattern</size>

actor User
participant "app:App" as App
box "commands" #FFFDE7
    participant "command:\nCommandTicketAddProduct" as Cmd
end box
box "controller" #E3F2FD
    participant "productController:\nProductController" as PC
    participant "ticketController:\nTicketController" as TC
end box
box "persistence" #FFF3E0
    participant "productDB:\nProductDB" as PDB
end box
box "models" #FCE4EC
    participant "ticket:Ticket" as Ticket
    participant "product:Product" as Product
    participant "<<enumeration>>\nCategories" as Cat
end box

autonumber "<b>[0]"

User -> App ++: ticket add <prodId> <quantity>
activate User

App -> App: parse command (prodId, quantity)

App -> Cmd **: new CommandTicketAddProduct(args)
activate Cmd
App -> Cmd ++: execute()

Cmd -> PC ++: productoID(prodId)
activate PC

PC -> PDB ++: getProduct(prodId)
activate PDB

alt Product exists
    PDB --> PC --: Product
    deactivate PDB
    PC --> Cmd --: Product
    deactivate PC

    Cmd -> TC ++: add(product, quantity)
    activate TC

    alt counter < 100 (capacity check)
        loop for i = 0 to quantity
            TC -> Ticket ++: addProduct(product)
            activate Ticket
            Ticket --> TC --: success
            deactivate Ticket
            note right of TC
              Incluye check products.size() < 100
            end note
            TC -> TC: update counter
        end loop

        TC -> TC: print()
        TC -> Cat ++: getDiscount(category)
        Cat --> TC --: discount
        deactivate Cat

        TC --> Cmd --: void
        deactivate TC

        Cmd --> App --: "ticket add: ok"
        deactivate Cmd
        App -> User: "ticket add: ok"

    else counter >= 100 (ticket full)
        TC --> Cmd --: "Ticket lleno."
        deactivate TC
        Cmd --> App --: "Ticket lleno."
        deactivate Cmd
        App -> User: "Ticket lleno."
    end

else Product doesn't exist
    PDB --> PC --: null
    deactivate PDB
    PC --> Cmd --: null
    deactivate PC
    Cmd --> App --: "ID no existe"
    deactivate Cmd
    App -> User: "ID no existe"
end

deactivate User
deactivate App

note over App, Cmd
  <b>Patrón Command:</b>
  App no sabe cómo añadir el producto;
  solo sabe ejecutar el Command.
  El Command coordina PC y TC.
end note

@enduml
