@startuml State_Diagram

skinparam backgroundColor #FEFEFE
skinparam defaultFontName Arial
skinparam stateBorderColor #1976D2
skinparam stateBackgroundColor #E3F2FD
skinparam stateArrowColor #1976D2

title UPM Tienda - State Diagram\n<size:12>Product and Ticket Lifecycle States</size>

state "Product Lifecycle" as ProductLife {

  [*] --> Creado

  state Creado {
    Creado : entry / Validar categoría
    Creado : entry / Comprobar ID único
    Creado : entry / Comprobar contador < 200
    Creado : do / Crear instancia de Producto
    Creado : do / Añadir a lista de productos
    Creado : do / contador++
    Creado : exit / Mostrar detalles del producto
  }

  Creado --> Activo

  state Activo {
    Activo : Producto en catálogo
    Activo : Puede listarse
    Activo : Puede añadirse a tickets
    Activo : Puede modificarse
  }

  Activo --> Actualizando

  state Actualizando {
    state "Actualizar Nombre" as UpdateName
    state "Actualizar Categoría" as UpdateCat
    state "Actualizar Precio" as UpdatePrice

    [*] --> CheckField

    CheckField --> UpdateName
    CheckField --> UpdateCat
    CheckField --> UpdatePrice

    UpdateName : Parsear nombre
    UpdateName : Asignar nuevo nombre

    UpdateCat : Validar categoría
    UpdateCat : Asignar nueva categoría

    UpdatePrice : Parsear valor double
    UpdatePrice : Asignar nuevo precio

    UpdateName --> Actualizando
    UpdateCat --> Actualizando
    UpdatePrice --> Actualizando
  }

  Actualizando --> Activo

  Activo --> EnTicket

  state EnTicket {
    EnTicket : Referenciado en ticket
    EnTicket : Puede actualizarse
    EnTicket : Afecta cálculos del ticket
  }

  EnTicket --> Activo
  EnTicket --> EnTicket : [update]

  Activo --> Eliminado
  EnTicket --> Eliminado

  state Eliminado {
    Eliminado : entry / Mostrar info producto
    Eliminado : do / Eliminar de lista
    Eliminado : do / contador--
    Eliminado : exit / Producto borrado
  }

  Eliminado --> [*]
}

state "Ticket Lifecycle" as TicketLife {

  [*] --> Vacio

  state Vacio {
    Vacio : estado = States.VACIO
    Vacio : Sin productos (0)
  }

  state ActivoT {
    ActivoT : estado = States.ACTIVO
    ActivoT : Contiene 1-100 productos
    ActivoT : Comprueba capacidad (máx 100)

    state "Chequeo Capacidad" as CapCheck
    state "Cálculo Descuento" as DiscountCalc

    [*] --> CapCheck : [addProduct]
    CapCheck --> DiscountCalc : [capacity < 100]
    CapCheck --> ActivoT : [capacity = 100] / No se puede añadir

    DiscountCalc --> ActivoT
  }

  state Cerrado {
    Cerrado : estado = States.CERRADO
    Cerrado : No se pueden añadir productos
  }

  Vacio --> ActivoT : addProduct [!products.isEmpty()]
  ActivoT --> Vacio : removeProduct [products.size() = 0]

  ActivoT --> Cerrado : printAndClose()

  Cerrado --> [*]
}

note right of TicketLife
  <b>Ticket States (States Enum)</b>
  Vacio - Sin productos.
  Activo - 1 a 100 productos (incluye lógica de capacidad).
  Cerrado - Finalizado, no modificable.

  <b>Reglas de negocio</b>
  • Descuento si ≥2 productos misma categoría
  • Capacidad máx 100 productos
  • Cierre al ejecutar 'printAndClose()'
end note

note bottom
  <b>Convenciones UML</b>
  • entry / Acciones al entrar
  • do / Acciones durante
  • exit / Acciones al salir
  • [Guard] / Condición de transición
end note

@enduml
