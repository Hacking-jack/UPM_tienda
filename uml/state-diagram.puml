@startuml State_Diagram

skinparam backgroundColor #FEFEFE
skinparam defaultFontName Arial
skinparam stateBorderColor #1976D2
skinparam stateBackgroundColor #E3F2FD
skinparam stateArrowColor #1976D2

title UPM Tienda - State Diagram\n<size:12>Product and Ticket Lifecycle States</size>

state "Product Lifecycle" as ProductLife {

  [*] --> Created

  state Created {
    Created : entry / Validate category
    Created : entry / Check unique ID
    Created : entry / Check counter < 200
    Created : do / Create Product instance
    Created : do / Add to products list
    Created : do / counter++
    Created : exit / Display product details
  }

  Created --> Active

  state Active {
    Active : Product is in catalog
    Active : Can be listed
    Active : Can be added to tickets
    Active : Can be modified
  }

  Active --> Updating

  state Updating {
    state "Update Name" as UpdateName
    state "Update Category" as UpdateCat
    state "Update Price" as UpdatePrice

    [*] --> CheckField

    CheckField --> UpdateName
    CheckField --> UpdateCat
    CheckField --> UpdatePrice

    UpdateName : Parse quoted name
    UpdateName : Set new name

    UpdateCat : Validate category
    UpdateCat : Set new category

    UpdatePrice : Parse double value
    UpdatePrice : Set new price

    UpdateName --> [*]
    UpdateCat --> [*]
    UpdatePrice --> [*]
  }

  Updating --> Active

  Active --> InTicket

  state InTicket {
    InTicket : Referenced in ticket
    InTicket : Can still be updated
    InTicket : Affects ticket calculations
  }

  InTicket --> Active
  InTicket --> InTicket

  Active --> Removed
  InTicket --> Removed

  state Removed {
    Removed : entry / Display product info
    Removed : do / Remove from list
    Removed : do / counter--
    Removed : exit / Product deleted
  }

  Removed --> [*]
}

state "Ticket Lifecycle" as TicketLife {

  [*] --> VACIO

  state VACIO {
    VACIO : estado = States.VACIO
    VACIO : No products (0)
  }

  state ACTIVO {
    ACTIVO : estado = States.ACTIVO
    ACTIVO : Contains 1-100 products
    ACTIVO : Checks capacity internally (100 max)

    state "Capacity Check" as CapCheck
    state "Discount Calculation" as DiscountCalc

    [*] --> CapCheck : [addProduct]
    CapCheck --> DiscountCalc : [capacity < 100]
    CapCheck --> ACTIVO : [capacity = 100] (No se puede añadir)

    DiscountCalc --> ACTIVO
  }

  state CERRADO {
    CERRADO : estado = States.CERRADO
    CERRADO : No se pueden añadir productos
  }

  VACIO --> ACTIVO : addProduct [products.isEmpty()]
  ACTIVO --> VACIO : removeProduct [products.size() = 0]

  ACTIVO --> CERRADO : printAndClose()

  CERRADO --> [*]
}

note right of TicketLife
  <b>Ticket States (States Enum)</b>
  VACIO - No products.
  ACTIVO - 1 to 100 products (includes logic for capacity check).
  CERRADO - Finalized, cannot be modified.

  <b>Business Rules</b>
  Discount >=2 same category
  Capacity max 100 products
  Closure occurs upon 'printAndClose()'
end note

note bottom
  <b>State Transitions</b>
  Solid arrows indicate normal flow

  <b>State Annotations</b>
  entry / Actions when entering state
  do / Actions while in state
  exit / Actions when leaving state
  [Guard] / Condition for transition
end note

@enduml