@startuml Activity_Diagram

skinparam backgroundColor #FEFEFE
skinparam defaultFontName Arial
skinparam activityDiamondBackgroundColor #E3F2FD
skinparam activityStartColor #4CAF50
skinparam activityEndColor #F44336
skinparam activityBackgroundColor #FFF9C4
skinparam activityBorderColor #FBC02D

title UPM Tienda - Activity Diagram\n<size:12>Main Application Flow with Command Processing</size>

start

:Initialize Application;
note right
  • Create ProductController
  • Create Ticket
  • Create TicketController
  • Display welcome message
end note

:Display prompt "tUPM>";

repeat

  :Read user input command;

  :Parse command (split by spaces);

  switch (Main command?)

  case (help)
    :Display all available commands;
    :Show categories and discounts;

  case (exit)
    :Set loop flag to false;

  case (prod)

    switch (Sub-command?)

    case (add)
      :Parse: id, name, category, price;
      :Reorder quoted name if needed;

      if (Valid category?) then (yes)
        if (ID unique?) then (yes)
          if (Counter < 200?) then (yes)
            :Create new Product;
            :Add to product list;
            :Increment counter;
            :Display product details;
            :Print "prod add: ok";
          else (no)
            :Display "Catálogo de productos lleno";
          endif
        else (no)
          :Display "Error. Ya existe el id";
        endif
      else (no)
        :Display "Categoría no válida";
      endif

    case (list)
      :Display "Catalog:";

      repeat
        :Get next product;
        :Display product.toString();
      repeat while (More products?) is (yes)
      ->no;

      :Print "prod list: ok";

    case (update)
      :Parse: id, field, value;

      if (Field is NAME?) then (yes)
        :Reorder quoted name;
      endif

      if (ID exists?) then (yes)
        :Get product by ID;

        switch (Field type?)
        case (NAME)
          :Update product name;
        case (CATEGORY)
          if (Valid category?) then (yes)
            :Update product category;
          else (no)
            :Display "Categoría no válida";
          endif
        case (PRICE)
          :Update product price;
        endswitch

        :Display updated product;
        :Print "prod update: ok";
      else (no)
        :Display "Error. No existe el id";
      endif

    case (remove)
      :Parse: id;

      if (ID exists?) then (yes)
        :Get product by ID;
        :Display product details;
        :Remove from list;
        :Decrement counter;
        :Print "prod remove: ok";
      else (no)
        :Display "Error. No existe el id";
      endif

    case (default)
      :Display "Comando no válido";
    endswitch

  case (ticket)

    switch (Sub-command?)

    case (new)
      :Create new Ticket instance;
      :Reset counter to 0;
      :Print "ticket new: ok";

    case (add)
      :Parse: prodId, quantity;

      if (Product ID exists?) then (yes)
        :Get product by ID;

        if (Counter < 100?) then (yes)

          repeat
            :Add product to ticket;
            :Increment counter;
          repeat while (quantity times) is (more)
          ->done;

          :Calculate and print receipt;

          floating note right
            <b>Receipt calculation:</b>
            1. Count products per category
            2. Calculate total price
            3. Apply discounts (≥2 same category)
            4. Calculate final price
          end note

          :Print "ticket add: ok";
        else (no)
          :Display "Ticket lleno";
        endif
      else (no)
        :Display "ID no existe";
      endif

    case (remove)
      :Parse: prodId;

      if (Product ID exists?) then (yes)
        :Get product by ID;

        repeat
          :Remove product from ticket;
          :Decrement counter;
        repeat while (Product still in ticket?) is (yes)
        ->no;

        :Print "ticket remove: ok";
      else (no)
        :Display "ID no existe";
      endif

    case (print)
      :Initialize price variables;
      :Initialize category counters;

      partition "Count Categories" {
        repeat
          :Get product category;
          :Increment category counter;
        repeat while (More products?) is (yes)
        ->no;
      }

      partition "Calculate & Print" {
        repeat
          :Get product (reverse order);
          :Add price to total;

          if (Category count ≥ 2?) then (yes)
            :Get discount percentage;
            :Calculate discount amount;
            :Add to total discount;
            :Print product with discount;
          else (no)
            :Print product without discount;
          endif
        repeat while (More products?) is (yes)
        ->no;
      }

      :Calculate final price;
      :Display total price;
      :Display total discount;
      :Display final price;
      :Print "ticket print: ok";

    case (default)
      :Display "Comando no válido";
    endswitch

  case (echo)
    :Print entire command line;

  case (default)
    :Display "Comando no válido, usa help";
  endswitch

backward :Continue;

repeat while (Exit command?) is (not executed)
->exit executed;

:Display "Closing application";
:Display "Goodbye!";

stop

note right
  <b>Error Handling:</b>
  • NumberFormatException
  • ArrayIndexOutOfBoundsException
  → Display "Formato del comando incorrecto"
end note

legend left
  <b>Color Legend:</b>
  • Yellow: Standard activities
  • Blue diamonds: Decisions
  • Green: Start
  • Red: End

  <b>Constraints:</b>
  • Max 200 products in catalog
  • Max 100 products per ticket
  • Discount when ≥2 same category
endlegend

@enduml

